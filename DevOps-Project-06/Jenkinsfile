pipeline {
    agent { label 'maven' }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                dir('DevOps-Project-06') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Deploy Jar') {
            steps {
                dir('DevOps-Project-06') {
                    sh 'mvn deploy -DskipTests'
                }
            }
        }

      stage('Docker Build') {
    steps {
        dir('DevOps-Project-06') {
            sh """
                docker build -t bharatm99/demo-workshop:${BUILD_NUMBER} .
            """
        }
    }
}

stage('Docker Push') {
    steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds',
                          usernameVariable: 'DOCKER_USER',
                          passwordVariable: 'DOCKER_PASS')]) {

            sh """
                echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                docker push bharatm99/demo-workshop:${BUILD_NUMBER}
            """
        }
    }
}
       stage('Run Docker Container') {
    steps {
        sh '''
          echo "Stopping old container if exists"
          docker ps -q --filter "name=demo-app" | grep -q . && docker stop demo-app || true
          docker rm demo-app || true

          echo "Running new container"
          docker run -d \
            -p 8081:8000 \
            --name demo-app \
            demo-workshop:${BUILD_NUMBER}
        '''
    }
}
    }
}
